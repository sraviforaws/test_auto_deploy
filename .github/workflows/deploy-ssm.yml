name: Deploy Python App via SSM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code (optional, for context or secrets)
      - uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_SECRET_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1   # Change to your region

      # 3️⃣ Send SSM command and deploy
      - name: Deploy to EC2 via SSM
        id: ssm
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          APP_DIR="/home/ec2-user/app"
          REPO="https://github.com/sraviforaws/test_auto_deploy.git"

          echo "Sending SSM command to instance $INSTANCE_ID..."

          CMD_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deployment" \
            --parameters 'commands=[
              "set -e",
              "export HOME=/home/ec2-user",
              "echo \"Step 1: Checking if app directory exists...\"",
              "if [ ! -d \"'"$APP_DIR"'/.git\" ]; then",
              "  echo \"Directory not found. Cloning repo...\"",
              "  git clone '"$REPO"' '"$APP_DIR"'",
              "else",
              "  echo \"Directory exists. Pulling latest changes...\"",
              "  cd '"$APP_DIR"'",
              "  git pull origin main",
              "fi",
              "git config --global --add safe.directory '"$APP_DIR"'",
              "cd '"$APP_DIR"'",
              "echo \"Step 2: Current user: $(whoami)\"",
              "echo \"Step 3: Running Python script...\"",
              "python3 -u myfile.py > output.log 2>&1",
              "echo \"------ Python Output ------\"",
              "cat output.log"
            ]' \
            --query "Command.CommandId" --output text)

          echo "Command ID: $CMD_ID"

          # Wait for SSM command to complete
          STATUS="Pending"
          while [[ "$STATUS" == "Pending" || "$STATUS" == "InProgress" ]]; do
            sleep 3
            STATUS=$(aws ssm list-command-invocations --command-id "$CMD_ID" --details \
              --query "CommandInvocations[0].Status" --output text)
            echo "SSM command status: $STATUS"
          done

          # Fetch stdout and stderr
          STDOUT=$(aws ssm get-command-invocation --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardOutputContent" --output text)

          STDERR=$(aws ssm get-command-invocation --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardErrorContent" --output text)

          echo "------ Python Output ------"
          echo "$STDOUT"

          # Fail the workflow if the SSM command failed
          if [[ "$STATUS" != "Success" ]]; then
            echo "SSM command failed with status: $STATUS"
            echo "------ Errors ------"
            echo "$STDERR"
            exit 1
          fi

          # Print any warnings/errors without failing
          if [ -n "$STDERR" ]; then
            echo "------ Warnings / Errors ------"
            echo "$STDERR"
          fi
