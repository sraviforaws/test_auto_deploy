name: Deploy Python App via SSM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code (optional, for context or secrets)
      - uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_SECRET_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1   # Change to your region

      # 3️⃣ Send SSM command and capture Command ID
            - name: Deploy to EC2 via SSM
        id: ssm
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          APP_DIR="/home/ec2-user/app"
          REPO="https://github.com/sraviforaws/test_auto_deploy.git"

          echo "Sending SSM command to instance $INSTANCE_ID..."

          CMD_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deployment" \
            --parameters 'commands=[
              "set -e",
              "if [ ! -d \"'"$APP_DIR"'/.git\" ]; then git clone '"$REPO"' '"$APP_DIR"'; fi",
              "cd '"$APP_DIR"'",
              "git pull origin main",
              "python3 -u myfile.py > output.log 2>&1",
              "cat output.log"
            ]' \
            --query "Command.CommandId" --output text)

          echo "Command ID: $CMD_ID"

          # Wait for command to finish
          STATUS="Pending"
          while [[ "$STATUS" == "Pending" || "$STATUS" == "InProgress" ]]; do
            sleep 3
            STATUS=$(aws ssm list-command-invocations --command-id "$CMD_ID" --details \
              --query "CommandInvocations[0].Status" --output text)
            echo "Status: $STATUS"
          done

          # Fetch stdout
          STDOUT=$(aws ssm get-command-invocation --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardOutputContent" --output text)
          echo "------ Python Output ------"
          echo "$STDOUT"

          # Fetch stderr
          STDERR=$(aws ssm get-command-invocation --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardErrorContent" --output text)
          if [ -n "$STDERR" ]; then
            echo "------ Errors ------"
            echo "$STDERR"
          fi

